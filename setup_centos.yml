---
- hosts: exp

  tasks:
    - name: upgrade all packages, excluding kernel
      yum:
        name: '*'
        state: latest
        exclude: kernel*

    - name: ensure a list of packages installed
      yum:
        name: "{{ packages }}"
        state: latest
      vars:
        packages:
        - epel-release
        - vim
        - nano
        - mc
        - net-tools
        - traceroute
        - tcpdump
        - sysstat
        - iotop
        - git
        - open-vm-tools
        - bind-utils
        - tree
        - htop
        - nmon
        - atop
        - bridge-utils
        - iperf3
        - bash-completion
        - iftop
        - curl
      tags:
        - install_pkg
        
    - name: Make sure we have a 'wheel' group
      group:
        name: wheel
        state: present

    - name: Allow 'wheel' group to have passwordless sudo
      lineinfile:
        dest: /etc/sudoers
        state: present
        regexp: '^%wheel'
        line: '%wheel ALL=(ALL) NOPASSWD: ALL'
        validate: 'visudo -cf %s'

#    - name: Add sudoers users to wheel group
#      user: name=chatbot groups=wheel append=yes state=present createhome=yes

    - name: Add /usr/local/bin to Securing path
      replace:
        dest: /etc/sudoers
#        state: present
#        backrefs: yes
#       regexp: '^(.*)secure_path = /(.*)$'
#        line: 'Defaults    secure_path = /usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin'
        regexp: '^(.*)(secure_path = )(/sbin:)(.*)$'
        replace: '\1\2/usr/local/bin:\3\4'
        validate: 'visudo -cf %s'
      tags:
         - sudo_path


